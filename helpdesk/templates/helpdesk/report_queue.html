{% extends "helpdesk/base.html" %}

{% load i18n static %}

{% block helpdesk_title %}Rapport File {{ queue }}{% endblock %}

{% block helpdesk_body %}
    <div class="page-title">
        <div class="h4 title_left">
            <a href="{% url 'helpdesk:report_index' %}">
                <i class="fas fa-chevron-circle-left"></i>
                {% trans "Reports &amp; Statistics" %}
            </a>
        </div>
    </div>

    <div class="clearfix"></div>

    <div class="x_panel">
        <div class="x_title">
            <h2>Evolution de la File {{ queue }}</h2>
            <ul class="nav navbar-right panel_toolbox">
                <li><a class="collapse-link"><i class="fas fa-chevron-up"></i></a></li>
            </ul>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            {% include 'base/components/date_range_picker_filter.html' with no_column_select=True %}

            <p>
                Dans ce tableau, les statistiques affichées correspondent bien au moment où l'action
                s'est produite durant la période définie ci-dessus.<br>
                Par exemple, pour la colonne <b>Fermé</b>, cela signifie le nombre de ticket qui ont été fermés entre
                le <b>{{ from|date }}</b> et le <b>{{ to|date }}</b>.
            </p>

            <table class="table table-striped table-bordered table-hover">
                <thead>
                <tr>
                    <th class="text-center">{% trans "Open" %}</th>
                    <th class="text-center">{% trans "Resolved" %}</th>
                    <th class="text-center">{% trans "Closed" %}</th>
                </tr>
                </thead>
                <tbody>
                    <tr>
                        {% url 'helpdesk:list' as ticket_list %}
                        <td class="text-center middle h3">
                            {% if open_total %}
                                <a href="{{ ticket_list }}?queues={{ queue.id }}&status=1&status=2&status=3&status=4&date_from={{ from|date:"Y-m-d" }}&date_to={{ to|date:"Y-m-d" }}">
                            {% endif %}
                            {{ open_total }}
                            {% if open_total %}</a>{% endif %}
                            <br>
                            <small>{{ open_average|floatformat:1 }} par jour</small>
                        </td>
                        <td class="text-center middle h3">
                            {% if resolved_total %}
                                <a href="{{ ticket_list }}?queues={{ queue.id }}&status=3&status=4&date_from={{ from|date:"Y-m-d" }}&date_to={{ to|date:"Y-m-d" }}">
                            {% endif %}
                            {{ resolved_total }}
                            {% if resolved_total %}</a>{% endif %}
                            <br>
                            <small>{{ resolved_average|floatformat:1 }} par jour</small>
                        </td>
                        <td class="text-center middle h3">
                            {% if closed_total %}
                                <a href="{{ ticket_list }}?queues={{ queue.id }}&status=4&date_from={{ from|date:"Y-m-d" }}&date_to={{ to|date:"Y-m-d" }}">
                            {% endif %}
                            {{ closed_total }}
                            {% if closed_total %}</a>{% endif %}
                            <br>
                            <small>{{ closed_average|floatformat:1 }} par jour</small>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="flot-chart">
                <div class="flot-chart-content" id="chart-content"></div>
            </div>
        </div>
    </div>

    <div class="x_panel">
        <div class="x_title">
            <h2>Rapport par techniciens</h2>
            <ul class="nav navbar-right panel_toolbox">
                <li><a class="collapse-link"><i class="fas fa-chevron-up"></i></a></li>
            </ul>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            <table class="table table-striped table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Technicien</th>
                        <th>{% trans "Open" %}</th>
                        <th>{% trans "Resolved" %}</th>
                        <th>{% trans "Closed" %}</th>
                        <th>Moyenne première réponse</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user, stats in user_stats.items %}
                        <tr>
                            <td>{{ user }}</td>
                            <td>{{ stats.open_total }}</td>
                            <td>{{ stats.resolved_total }}</td>
                            <td>{{ stats.closed_total }}</td>
                            <td>
                                {% include 'helpdesk/include/first_answer_time_average_and_percentage.html' with object=stats %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="flot-chart">
                <div class="flot-chart-content" id="chart-user-content"></div>
            </div>
        </div>
    </div>

    <div class="x_panel">
        <div class="x_title">
            <h2>Evolution des types de tickets</h2>
            <ul class="nav navbar-right panel_toolbox">
                <li><a class="collapse-link"><i class="fas fa-chevron-up"></i></a></li>
            </ul>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            <div class="flot-chart">
                <div class="flot-chart-content" id="chart-ticket-types"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_javascripts %}
    {% if morrisjs_data %}
        <!-- Flot Charts JavaScript -->
        <script src="{% static 'helpdesk/vendor/flot/excanvas.min.js' %}"></script>
        <script src="{% static 'helpdesk/vendor/flot/jquery.flot.js' %}"></script>
        <script src="{% static 'helpdesk/vendor/flot/jquery.flot.categories.js' %}"></script>
        <script src="{% static 'helpdesk/vendor/flot/jquery.flot.pie.js' %}"></script>
        <script src="{% static 'helpdesk/vendor/flot/jquery.flot.resize.js' %}"></script>
        <script src="{% static 'helpdesk/vendor/flot/jquery.flot.time.js' %}"></script>
        <script src="{% static 'helpdesk/vendor/flot-tooltip/jquery.flot.tooltip.min.js' %}"></script>
        <script src="{% static 'helpdesk/vendor/raphael/raphael.min.js' %}"></script>
        <script src="{% static 'helpdesk/vendor/morrisjs/morris.min.js' %}"></script>
        <script>
            Morris.Line({
                element: 'chart-content',
                data: {% autoescape on %}{{ morrisjs_data|safe }}{% endautoescape %},
                xkey: 'x',
                ykeys: [{% for state in status %}"{{ state }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                labels: [{% for state in status %}"{{ state }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                xLabels: "day",
                xLabelFormat: function (d) {
                    return d.toLocaleDateString()
                },
                resize: true
            });

            Morris.Bar({
                element: 'chart-user-content',
                data: {% autoescape on %}{{ morrisjs_data_users|safe }}{% endautoescape %},
                xkey: 'x',
                ykeys: [{% for user_name in user_stats.keys %}"{{ user_name }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                labels: [{% for user_name in user_stats.keys %}"{{ user_name }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                resize: true
            });

            Morris.Bar({
                element: 'chart-ticket-types',
                data: {% autoescape on %}{{ type_stats|safe }}{% endautoescape %},
                xkey: 'x',
                ykeys: [{% for v in mapping_types.values %}"{{ v }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                labels: [{% for v in mapping_types.values %}"{{ v }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                resize: true,
                stacked: true
            });
        </script>
    {% endif %}
{% endblock %}