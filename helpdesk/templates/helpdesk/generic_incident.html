{% extends "helpdesk/base.html" %}

{% block helpdesk_title %}Incident Générique {{ generic_incident }}{% endblock %}
{% block h1_title %}{% endblock %}

{% block helpdesk_body %}
    {% if request.user.is_staff %}
        <div class="page-title">
            <div class="h4 title_left">
                <a href="{% url 'helpdesk:generic_incident_list' %}">
                    <i class="fas fa-chevron-circle-left"></i> Retour à la liste des incidents
                </a>
            </div>
        </div>
    {% endif %}

    <div class="x_panel">
        <div class="x_title">
            <h2>Détail de l'incident générique <b>{{ generic_incident }}</b></h2>
            <ul class="nav navbar-right panel_toolbox">
                {% if request.user.is_staff %}
                    {% if generic_incident.archived %}
                        <li>
                            <a class="askConfirmation"
                               data-message="Êtes-vous sûr de vouloir désarchiver l'IG {{ generic_incident }} ?"
                                href="{% url 'helpdesk:generic_incident_toggle_archived' generic_incident.id %}">
                                <i class="fa fa-archive"></i>
                                Désarchiver l'incident
                            </a>
                        </li>
                    {% else %}
                        <li>
                            <a class="askConfirmation"
                               data-message="Êtes-vous sûr de vouloir archiver l'IG {{ generic_incident }} ?"
                                href="{% url 'helpdesk:generic_incident_toggle_archived' generic_incident.id %}">
                                <i class="fa fa-archive"></i>
                                Archiver l'incident
                            </a>
                        </li>
                    {% endif %}
                    <li class="divider"></li>
                    <li>
                        <a href="{% url 'helpdesk:generic_incident_update' generic_incident.id %}">
                            <i class="fas fa-edit"></i>
                            Editer l'incident
                        </a>
                    </li>
                    <li class="divider"></li>
                    <li>
                        <a href="{% url 'helpdesk:generic_incident_delete' generic_incident.id %}">
                            <i class="fas fa-trash"></i>
                            Supprimer l'incident
                        </a>
                    </li>
                    <li class="divider"></li>
                {% endif %}
                <li><a class="collapse-link"><i class="fas fa-chevron-up"></i></a></li>
            </ul>
            <div class="clearfix"></div>
        </div>
        <div class="x_content">
            <div class="row">
                <div class="col-sm-8 col-xs-12">
                    <div class="row">
                        <div class="col-sm-6 col-xs-12">
                            Date de début d'incident : <b>{{ generic_incident.start_date }}</b>
                        </div>
                        <div class="col-sm-6 col-xs-12 text-right">
                            Date de début d'incident : <b>{{ generic_incident.end_date|default:"En cours" }}</b>
                        </div>
                    </div>
                    <h4>
                        Nombre de personnes abonnées
                        <span class="badge" id="subscribersCount">{{ generic_incident.subscribers.count }}</span>
                    </h4>
                    {% if request.user.is_staff %}
                        <h4>
                            Tickets liés
                            <span class="badge" title="Nombre total de tickets liés">{{ generic_incident.tickets.count }}</span>
                        </h4>
                        <div class="list-group">
                            {% for ticket in generic_incident.tickets.all %}
                                <a class="list-group-item" href="{{ ticket.get_absolute_url }}">{{ ticket }}</a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <h4>Mes tickets liés</h4>
                        <div class="list-group">
                            {% for ticket in authorized_tickets %}
                                <a class="list-group-item" href="{{ ticket.get_absolute_url }}">{{ ticket }}</a>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-sm-4 col-xs-12">
                    <h4>Catégorie : <b>{{ generic_incident.category|default:"Non définie" }}</b></h4>
                    <h4>
                        Rapport d'incident :
                        {% if generic_incident.intervention_report %}
                            <a class="btn btn-default btn-sm" href="{{ generic_incident.intervention_report.url }}" target="_blank">
                                <i class="fa fa-download"></i>
                            </a>
                        {% else %}
                            <span class="text-italic">Non disponible</span>
                        {% endif %}
                    </h4>
                    {% if generic_incident.description %}
                        <h4>Description :</h4>
                        <div class="well well-sm">
                            {{ generic_incident.description|linebreaksbr }}
                        </div>
                    {% endif %}
                    {% if request.user.is_staff and generic_incident.external_link %}
                        <p>
                            Lien externe :
                            <a href="{{ generic_incident.external_link }}" target="_blank">
                                {{ generic_incident.external_link }}
                                <i class="fa fa-external-link"></i>
                            </a>
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% include 'sphinx/components/generic_information.html' with information_title='Suivis' show_subscribe=True %}
{% endblock %}

{% block custom_javascripts %}
    <script>
        $(() => {
            {# Call the toggle subscribe view when the switch input is clicked. Also update the subscribers count #}
            $('#switchInput').on('change', function() {
                $.post('{% url 'helpdesk:generic_incident_toggle_subscribe' generic_incident.id %}')
                    .done(response => {
                        if (response.success) {
                            const subscribersCount = parseInt($('#subscribersCount').text())
                            let message;
                            if (response.subscribed) {
                                message = "Vous recevrez dorénavant une notification lors d'une mise à jour sur cet incident générique."
                                $('#subscribersCount').text(subscribersCount + 1)
                            } else {
                                message = "Vous ne recevrez plus de notification lors des prochaines mises à jour sur cet incident générique."
                                $('#subscribersCount').text(subscribersCount - 1)
                            }
                            notification(message)
                        } else {
                            notification(response.error, 'error')
                            // Rollback the switch
                            $(this).prop('checked', !$(this).is(':checked'))
                        }
                    }).fail(ajaxFail)
            });
        })
    </script>
{% endblock %}