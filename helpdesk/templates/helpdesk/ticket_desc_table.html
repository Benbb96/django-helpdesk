{% load static i18n humanize ticket_to_link avatar_tags status_color base_tags %}

<div class="row">
    <div class="col-lg-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>
                    <i class="fas fa-ticket-alt"></i>
                    {{ ticket.id }}. {{ ticket.title }}
                    {% include 'helpdesk/include/status_label.html' %}
                </h2>
                <ul class="nav navbar-right panel_toolbox">
                    <li>
                        <a class="scrollTo" data-target="#followUps">
                            <i class="fas fa-arrow-down"></i>
                            Discussion
                        </a>
                    </li>
                    <li class="divider"></li>
                    {% if request.user.is_staff %}
                        <li>
                            <a href="{% url 'helpdesk:ticket_spent_times' ticket.id %}">
                                <i class="fas fa-hourglass-half"></i>
                                Temps passés
                            </a>
                        </li>
                        <li class="divider"></li>
                    {% endif %}
                    {% if request.user.employee.is_ipexia_member %}
                        <li>
                            <a href="{% url 'helpdesk:edit' ticket.id %}">
                                <i class="fas fa-pencil-alt"></i>
                                {% trans "Edit" %}
                            </a>
                        </li>
                        <li class="divider"></li>
                    {% endif %}
                    {% if request.user.is_staff %}
                        <li>
                            <a href="{% url 'helpdesk:delete' ticket.id %}">
                                <i class="far fa-trash-alt"></i>
                                {% trans "Delete" %}
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            {% if ticket.on_hold %}
                                <a href="{% url 'helpdesk:unhold' ticket.id %}">
                                    <i class="fas fa-play"></i>
                                    Retirer la mise en attente
                                </a>
                            {% else %}
                                <a href="{% url 'helpdesk:hold' ticket.id %}">
                                    <i class="fas fa-pause"></i>
                                    Mettre en attente client
                                </a>
                            {% endif %}
                        </li>
                        <li class="divider"></li>
                    {% endif %}
                    <li><a class="collapse-link"><i class="fas fa-chevron-up"></i></a></li>
                </ul>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th colspan='2'>
                            {% trans "Queue" %} : {{ ticket.queue }}
                            <div class="pull-right">
                                Date dernière modification :
                                <span class="label label-primary" style="font-size: 90%"
                                      title="{{ ticket.modified|date:"l j F Y à H:i:s" }}">
                                    {{ ticket.modified }}
                                </span>
                            </div>
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    {# Category, Type and Billing of the ticket #}
                    <tr>
                        <th class="text-right middle">Informations ticket</th>
                        <td>
                            <table class="table table-condensed" style="margin: auto">
                            <thead>
                            <tr>
                                <th>Catégorie</th>
                                <th>Type de ticket</th>
                                <th>Facturation</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>
                                    {% if request.user.is_staff %}
                                        <div class="form-group">
                                            {{ information_form.category }}
                                        </div>
                                    {% else %}
                                        {{ ticket.category|default:"Non définie" }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if request.user.is_staff %}
                                        <div class="form-group">
                                            {{ information_form.type }}
                                        </div>
                                    {% else %}
                                        {{ ticket.type|default:"Non défini" }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if request.user.is_staff %}
                                        <div class="form-group">
                                            {{ information_form.billing }}
                                        </div>
                                    {% else %}
                                        {{ ticket.get_billing_display|default:"Non définie" }}
                                    {% endif %}
                                </td>
                            </tr>
                            </tbody>
                            </table>
                        </td>
                    </tr>

                    {# Quick comment is only for staff users #}
                    {% if request.user.is_staff %}
                        <tr>
                            <th class="text-right middle">{{ form.quick_comment.label_tag }}</th>
                            <td>
                                <div class="input-group">
                                    {{ form.quick_comment }}
                                    <div class="input-group-btn">
                                        <button class="btn btn-default" id="saveQuickComment">
                                            <i class="fas fa-save" title="Enregistrer le commentaire rapide sur le ticket"></i>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endif %}

                    {# Ticket description #}
                    <tr>
                        <th class="text-right middle">{% trans "Description" %}</th>
                        <td id="ticket-description">
                            {{ ticket.description|safe|num_to_link }}
                        </td>
                    </tr>

                    {# Ticket resolution #}
                    {% if ticket.resolution %}
                        <tr>
                            <th class="text-right middle">
                                {% trans "Resolution" %}
                            </th>
                            <td>
                                {% if ticket.status == ticket.RESOLVED_STATUS or ticket.status == ticket.REOPENED_STATUS %}
                                    <div class="btn-group pull-right">
                                        <a href='?close' class="btn btn-success"
                                           title="Accepter la solution proposée et fermer ce ticket.{% if request.user.is_staff %} Un email sera envoyé au client.{% endif %}">
                                            {% trans "Accept and Close" %}
                                        </a>
                                        {% if request.user.is_staff %}
                                            <button type="button" class="btn btn-success dropdown-toggle"
                                                    data-toggle="dropdown" aria-expanded="false">
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu" role="menu">
                                                <li>
                                                    <a href="?close&private" title="Aucun email ne sera envoyé au client.">
                                                        Fermer sans notifier le client
                                                    </a>
                                                </li>
                                            </ul>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                {{ ticket.resolution|safe|num_to_link }}
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>

                <div class="row">
                    <div class="col-sm-6 col-xs-12">
                        <table class="table table-striped table-bordered table-hover">
                            <tbody>
                            {# Assigned user #}
                            <tr>
                                <th class="text-right middle">{% trans "Assigned To" %}</th>
                                <td>
                                    {% if ticket.assigned_to %}
                                        <a href="{{ ticket.assigned_to.get_absolute_url }}">
                                            {% avatar ticket.assigned_to 30 class="img-circle" %}
                                            {{ ticket.assigned_to }}
                                        </a>
                                        &lt;{{ ticket.assigned_to.email }}&gt;
                                    {% elif request.user.is_staff %}
                                        <strong>
                                            <a href='?take'>
                                                <button type="button" class="btn btn-primary btn-xs">
                                                    <i class="far fa-hand-paper"></i>
                                                    {% trans "Take" %}
                                                </button>
                                            </a>
                                        </strong>
                                    {% else %}
                                        {% trans "Unassigned" %}
                                    {% endif %}
                                </td>
                            </tr>

                            {# Resolved date #}
                            {% if ticket.resolved %}
                                <tr>
                                    <th class="text-right middle">Résolu le</th>
                                    <td>{{ ticket.resolved|date:"l j F Y à H:i" }} ({{ ticket.resolved|naturaltime }})</td>
                                </tr>
                            {% endif %}

                            {# Closed date #}
                            {% if ticket.closed %}
                                <tr>
                                    <th class="text-right middle">Fermé le </th>
                                    <td>{{ ticket.closed|date:"l j F Y à H:i" }} ({{ ticket.closed|naturaltime }})</td>
                                </tr>
                            {% endif %}

                            {# Ticket priority #}
                            {% if request.user.is_staff %}
                                <tr>
                                    <th class="text-right middle">{% trans "Priority" %}</th>
                                    <td>
                                        <span class="badge {{ ticket.priority|priority_color }}">
                                            {{ ticket.get_priority_display }}
                                        </span>
                                    </td>
                                </tr>
                            {% endif %}

                            {# Ticket CC #}
                            <tr>
                                <th class="text-right middle">{% trans "Copies To" %}</th>
                                <td>
                                    {% for ticketcc in ticket.ticketcc_set.all %}
                                        {{ ticketcc.display }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                    {% if request.user.is_staff %}
                                        <a data-toggle='tooltip' href='{% url 'helpdesk:ticket_cc' ticket.id %}' class="btn btn-default btn-xs"
                                           title='{% trans "Click here to add / remove people who should receive an e-mail whenever this ticket is updated." %}'>
                                            <i class="fas fa-share"></i>
                                            {% trans "Manage" %}
                                        </a>
                                    {% endif %}
                                    {% if not user_already_subscribed %}
                                        <a data-toggle='tooltip' href='?subscribe' class="btn btn-info btn-xs"
                                           title='{% trans "Click here to subscribe yourself to this ticket, if you want to receive an e-mail whenever this ticket is updated." %}'>
                                            <i class="fas fa-rss"></i>
                                            {% trans "Subscribe" %}
                                        </a>
                                    {% endif %}
                                    <form method="post">
                                        {% csrf_token %}
                                        {{ ticketcc_form.email_input }}
                                        {{ ticketcc_form.email_input.errors }}
                                        <button type="submit" class="btn btn-default">Ajouter en copie</button>
                                    </form>
                                </td>
                            </tr>

                            {# Ticket dependencies #}
                            <tr>
                                <th class="text-right middle">{% trans "Dependencies" %}</th>
                                <td>{% for dep in ticket.ticketdependency.all %}
                                    {% if forloop.first %}
                                        <p>{% trans "This ticket cannot be resolved until the following ticket(s) are resolved" %}</p>
                                        <ul>{% endif %}
                                    <li>
                                        <a href='{{ dep.depends_on.get_absolute_url }}'>
                                            {{ dep.depends_on.ticket }} {{ dep.depends_on.title }}
                                        </a>
                                        ({{ dep.depends_on.get_status_display }})
                                        {% if request.user.is_staff %}
                                            <a href='{% url 'helpdesk:ticket_dependency_del' ticket.id dep.id %}' class="btn btn-warning btn-xs">
                                                <i class="fas fa-trash"></i>
                                                {% trans "Remove Dependency" %}
                                            </a>
                                        {% endif %}
                                    </li>
                                    {% if forloop.last %}</ul>{% endif %}
                                    {% empty %}
                                        <p>{% trans "This ticket has no dependencies." %}</p>
                                    {% endfor %}
                                    {% if request.user.is_staff %}
                                        <p>
                                            <a data-toggle='tooltip' href='{% url 'helpdesk:ticket_dependency_add' ticket.id %}' class="btn btn-primary btn-xs"
                                              title="{% trans "Click on 'Add Dependency', if you want to make this ticket dependent on another ticket. A ticket may not be closed until all tickets it depends on are closed." %}">
                                                <i class="fas fa-child"></i>
                                                {% trans "Add Dependency" %}
                                            </a>
                                        </p>
                                    {% endif %}
                                </td>
                            </tr>

                            {# Time before first answer #}
                            {% if ticket.time_before_first_answer is not None %}
                                <tr>
                                    <th class="text-right middle">Temps de première réponse</th>
                                    <td>
                                        <span data-toggle="tooltip" data-placement="right"
                                              title="Notre objectif est de répondre en moins d'une heure selon les plages de travail (du lundi au vendredi de 8h à 18h)">
                                            {{ ticket.time_before_first_answer|duration_in_hours }}
                                        </span>
                                    </td>
                                </tr>
                            {% endif %}

                            {# List custom fields at the end #}
                            {% for customfield in ticket.ticketcustomfieldvalue_set.all %}
                                <tr>
                                    <th>{{ customfield.field.label }}</th>
                                    <td>
                                        {% if customfield.field.data_type == "url" %}
                                            <a href='{{ customfield.value }}'>
                                                {{ customfield.value }}
                                            </a>
                                        {% else %}
                                            {{ customfield.value }}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="col-sm-6 col-xs-12">
                        <table class="table table-striped table-bordered table-hover">
                            <tbody>
                            {# Sender #}
                            <tr>
                                <th class="text-right middle">Émetteur</th>
                                <td>
                                    {% if ticket.customer_contact %}
                                        <a href="{{ ticket.customer_contact.get_absolute_url }}">
                                            {% avatar ticket.customer_contact 40 class="img-rounded-pull-left" %}
                                            {{ ticket.customer_contact }}
                                        </a>
                                        &lt;{% include 'base/components/mailto_link.html' with mail=ticket.customer_contact.email %}&gt;
                                        {% if ticket.customer_contact.email != ticket.submitter_email %}
                                            [Adresse initiale d'ouverture : {% include 'base/components/mailto_link.html' with mail=ticket.submitter_email %}]
                                        {% endif %}
                                    {% else %}
                                        {% include 'base/components/mailto_link.html' with mail=ticket.submitter_email %}
                                    {% endif %}
                                    {% if user.is_superuser and ticket.submitter_email %}
                                        <a href='{% url 'helpdesk:email_ignore_add' %}?email={% if ticket.customer_contact %}{{ ticket.customer_contact.email }}{% else %}{{ ticket.submitter_email }}{% endif %}&queue={{ ticket.queue.id }}'
                                           class="btn btn-warning btn-xs">
                                            <i class="fas fa-eye-slash"></i>
                                            {% trans "Ignore" %}
                                        </a>
                                    {% endif %}
                                    <br>
                                    {% if ticket.customer_contact.employee.phone_number %}
                                        {% include 'base/components/phone_number_link.html' with phone_number=ticket.customer_contact.employee.phone_number %}
                                        {% if ticket.contact_phone_number and ticket.contact_phone_number != ticket.customer_contact.employee.phone_number %}
                                            - Numéro renseigné sur le ticket :
                                            {% include 'base/components/phone_number_link.html' with phone_number=ticket.contact_phone_number %}
                                        {% endif %}
                                    {% elif ticket.customer_contact.employee.landline_number %}
                                        {% include 'base/components/phone_number_link.html' with phone_number=ticket.customer_contact.employee.landline_number %}
                                        {% if ticket.contact_phone_number and ticket.contact_phone_number != ticket.customer_contact.employee.landline_number %}
                                            - Numéro renseigné sur le ticket :
                                            {% include 'base/components/phone_number_link.html' with phone_number=ticket.contact_phone_number %}
                                        {% endif %}
                                    {% elif ticket.contact_phone_number %}
                                        {% include 'base/components/phone_number_link.html' with phone_number=ticket.contact_phone_number %}
                                    {% endif %}
                                </td>
                            </tr>

                            {# Creation Date #}
                            <tr>
                                <th class="text-right middle">{% trans "Submitted On" %}</th>
                                <td>{{ ticket.created|date:"l j F Y à H:i" }} ({{ ticket.created|naturaltime }})</td>
                            </tr>

                            {# Due Date #}
                            {% if ticket.due_date %}
                                <tr>
                                    <th class="text-right middle">{% trans "Due Date" %}</th>
                                    <td>
                                        {{ ticket.due_date|date:"l j F Y à H:i" }} ({{ ticket.due_date|naturaltime }})
                                    </td>
                                </tr>
                            {% endif %}

                            {# Generic incident #}
                            {% if ticket.generic_incident %}
                                <tr>
                                    <th class="text-right middle">Incident générique lié</th>
                                    <td>
                                        <a href="{{ ticket.generic_incident.get_absolute_url }}">
                                            {{ ticket.generic_incident }}
                                        </a>
                                        {% if ticket.generic_incident.end_date %}
                                            (du {{ ticket.generic_incident.start_date }}  au {{ ticket.generic_incident.end_date }})
                                        {% else %}
                                            (débuté il y a <span title="{{ ticket.generic_incident.start_date }}">{{ ticket.generic_incident.start_date|timesince }}</span>)
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}

                            {# Customer (or possible customers from contact) #}
                            {% if ticket.customer or ticket.customer_contact %}
                                <tr>
                                    <th class="text-right middle">Client</th>
                                    <td>
                                        {% if ticket.customer %}
                                            <a href="{{ ticket.customer.get_absolute_url }}">{{ ticket.customer }}</a>
                                        {% else %}
                                            {# List all customers from customer_contact and let user choose which one is the concerned customer #}
                                            <ul>
                                                {% for customer in ticket.customer_contact.employee.customers %}
                                                    <li>
                                                        <a href="{{ customer.get_absolute_url }}">{{ customer }}</a>
                                                        {% if request.user.is_staff %}
                                                            <a class="btn btn-default btn-xs"
                                                               href="{% url 'helpdesk:choose_customer_for_ticket' ticket.id customer.id %}"
                                                               title="Définir {{ customer }} comme client concerné par ce ticket">
                                                                Associer ce client
                                                            </a>
                                                        {% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}

                            {# Phoenix contextual fields #}
                            {% if ticket.site %}
                                <tr>
                                    <th class="text-right middle">Site</th>
                                    <td>
                                        <a href="{{ ticket.site.get_absolute_url }}">{{ ticket.site }}</a>
                                    </td>
                                </tr>
                            {% endif %}
                            {% if ticket.customer_product %}
                                <tr>
                                    <th class="text-right middle">Produit client</th>
                                    <td>
                                        <a href="{{ ticket.customer_product.get_absolute_url }}">{{ ticket.customer_product }}</a>
                                        {% if request.user.is_staff %}
                                            {% with gtr=ticket.customer_product.get_gtr %}
                                                {% if gtr %}
                                                    <br>{{ gtr }}
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                            {% if ticket.link_open %}
                                <tr>
                                    <th class="text-right middle">Lien vers la page où le ticket a été ouvert</th>
                                    <td>
                                        <a href="{{ ticket.link_open }}">{{ ticket.link_open }}</a>
                                    </td>
                                </tr>
                            {% endif %}

                            {% if request.user.is_staff %}
                                <tr>
                                    <th class="text-right middle">Gestion du chrono</th>
                                    <td>
                                        {% include 'base/components/spent_time/spent_time_controls.html' with content_type_id=ticket|content_type_id object_id=ticket.id ongoing_spent_times=ticket.spent_times.ongoing %}
                                    </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

